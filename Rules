#!/usr/bin/env ruby


preprocess do
  move_post_identifiers
  create_tag_pages
  generate_yearly_archive sorted_articles, :created_at, "Jahr"
  generate_weekly_archive sorted_articles, :created_at, "KW"
  # TODO: Create a “prev-next-link” cache.
  # generate_prev_next_links
end


compile '/static/*/' do
end

compile "/htaccess" do
  filter :erb
end

compile "/feed" do
  filter :erb
end

compile '*' do
  if item[:extension] == 'scss'
    filter :sass, {
      :syntax => :scss,
      #:style => :compressed,
    }
  elsif item.binary?
    # don’t filter binary items
  else
    filter :erb
    filter :kramdown, {
      :smart_quotes => 'sbquo,lsquo,bdquo,ldquo',
    }
    filter :add_figure_to_img
    layout 'default'
  end
end


route '/static/*/' do
  # /static/foo.html/ → /foo.html
  item.identifier[7..-2]
end

route "/htaccess" do
  "/.htaccess"
end

route "/feed" do
  "/feed/index.xml"
end

route "/snippets/*/" do
  nil
end

route '*' do
  if item[:extension] == 'scss'
    unless item.identifier.split("/")[-1].start_with?("_")
      # Do nothing when a SCSS file starts with an underscore.
      # Write item with identifier /foo/ to /foo.css
      item.identifier.chop + '.css'
    end
  elsif item.binary?
    # Write item with identifier /foo/ to /foo.ext
    item.identifier.chop + '.' + item[:extension]
  else
    # Write item with identifier /foo/ to /foo/index.html
    item.identifier + 'index.html'
  end
end


layout '*', :haml
